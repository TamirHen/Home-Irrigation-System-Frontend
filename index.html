<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel='icon' href='./favicon.ico' type='image/x-icon'>
    <link rel="stylesheet" type="text/css" href="default.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation System</title>
    <link href="https://fonts.googleapis.com/css2?family=Arvo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<body>
    <form class="main-container">
        <div class="header">Smart Irrigation System</div>
        <div class="irrigate-by-minutes-wrapper">
            <button class="irrigate-by-minutes-button">Irrigate By Minutes</button>
        </div>
        <div class="main-body">
            <div class="wrapper">

                <div class="wrapper">
                    <div class="cycles">
                        <div class="cycle">
                            <div class="header-wrapper">
                                <span class="mh2">First Cycle</span>
                                <div class="mid">
                                    <label class="rocker rocker-small">
                                    <input type="checkbox" id="cycle1">
                                    <span class="switch-left">ON</span>
                                    <span class="switch-right">OFF</span>
                                    </label>
                                </div>
                            </div>
                            <div class="time-picker">
                                <div class="time-picker-wrapper">
                                    <label class="time-label">Start</label>
                                    <input type="time" name="time" id="time" class="time1Start" />
                                </div>
                                <div class="time-picker-wrapper">
                                    <label class="time-label">End</label>
                                    <input type="time" name="time" id="time" class="time1End" />
                                </div>
                            </div>
                        </div>
                        <div class="cycle">
                            <div class="header-wrapper">
                                <span class="mh2">Second Cycle</span>
                                <div class="mid">
                                    <label class="rocker rocker-small">
                                    <input type="checkbox" id="cycle2">
                                    <span class="switch-left">ON</span>
                                    <span class="switch-right">OFF</span>
                                    </label>
                                </div>
                            </div>
                            <div class="time-picker">
                                <div class="time-picker-wrapper">
                                    <label class="time-label">Start</label>
                                    <input type="time" name="time" id="time" class="time2Start" />
                                </div>
                                <div class="time-picker-wrapper">
                                    <label class="time-label">End</label>
                                    <input type="time" name="time" id="time" class="time2End" />
                                </div>
                            </div>
                        </div>
                        <div class="cycle">
                            <div class="header-wrapper">
                                <span class="mh2">Third Cycle</span>
                                <div class="mid">
                                    <label class="rocker rocker-small">
                                    <input type="checkbox" id="cycle3">
                                    <span class="switch-left">ON</span>
                                    <span class="switch-right">OFF</span>
                                    </label>
                                </div>
                            </div>
                            <div class="time-picker">
                                <div class="time-picker-wrapper">
                                    <label class="time-label">Start</label>
                                    <input type="time" name="time" id="time" class="time3Start" />
                                </div>
                                <div class="time-picker-wrapper">
                                    <label class="time-label">End</label>
                                    <input type="time" name="time" id="time" class="time3End" />
                                </div>
                            </div>
                        </div>
                    </div>
    
                </div>

                <div class="week">     
                    
                    <ol class="switches">
                        <li>
                            <input type="checkbox" id="1" class="switch-input">
                            <label for="1">
                                <span class="mh3">Sunday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="2">
                            <label for="2">
                                <span class="mh3">Monday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="3">
                            <label for="3">
                                <span class="mh3">Tuesday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="4">
                            <label for="4">
                                <span class="mh3">Wednesday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="5">
                            <label for="5">
                                <span class="mh3">Thursday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="6">
                            <label for="6">
                                <span class="mh3">Friday</span>
                                <span></span>
                            </label>
                        </li>
                        <li>
                            <input type="checkbox" id="7">
                            <label for="7">
                                <span class="mh3">Saturday</span>
                                <span></span>
                            </label>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="save-wrapper">
            <button type="submit" class="submit-button">Save</button>
            <div id="submit-message"><p></p></div>
        </div>
        <div class="logout-wrapper">
            <button class="logout-button" id="logout-button">Logout</button>
        </div>

    </form>

    <div class="login-background"></div>

    <form class="login-wrapper" id="login-popup">
        <div class="login-popup">
            <span class="signin-label">Sign in</span>
            <input type="text" placeholder="Email" class="popup-input" id="email-input-signin" required>
            <input type="password" placeholder="Password" class="popup-input" id="password-input-signin" required>
            <button type="submit" class="login-button" id="signin-submit">Submit</button>
            <span id="signin-error-message" class="error-message"></span>
            <div class="signup-wrapper">
                <button class="signup" id="signup">Sign up</button>
            </div>
        </div>
    </form>

    <form class="login-wrapper" id="signup-popup">
        <div class="login-popup">
            <span class="signin-label">Sign up</span>
            <input type="text" placeholder="Email" class="popup-input" id="email-input-signup" required>
            <input type="password" placeholder="Password" class="popup-input" id="password-input-signup" required>
            <input type="text" placeholder="Dataplicity" class="popup-input" id="dataplicity-input-signup" required>
            <button type="submit" class="login-button" id="signup-submit">Submit</button>
            <span id="signup-error-message" class="error-message"></span>
            <div class="signup-wrapper">
                <button class="signup" id="back-to-login">Back to login</button>
            </div>
        </div>
    </form>

    <form class="login-wrapper" id="irrigate-by-minutes">
        <div class="login-popup">
            <span class="signin-label">For how long would you like to irrigate?</span>
            <input type="number" placeholder="Enter Minutes" class="popup-input" id="minutes-input" required>
            <div class="buttons-wrapper">
                <button class="login-button" id="close-button">Close</button>
                <button type="submit" class="login-button" id="irrigate-by-mintues-submit">Submit</button>
            </div>
            <div id="error-message-irrigate-by-minutes"><p></p></div>
        </div>
    </form>

  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-firestore.js"></script>

  <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-analytics.js"></script>
  
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCmWhdLsNWdcoy5n73aVuX2Wb17Qkw4MKw",
      authDomain: "smart-irrigation-system-854fa.firebaseapp.com",
      databaseURL: "https://smart-irrigation-system-854fa.firebaseio.com",
      projectId: "smart-irrigation-system-854fa",
      storageBucket: "smart-irrigation-system-854fa.appspot.com",
      messagingSenderId: "175621433547",
      appId: "1:175621433547:web:f80840fa5b9790147cd34e",
      measurementId: "G-C6JDMHJCFC"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>
  
    
    <script type="text/javascript">
        const auth = firebase.auth();
        const db = firebase.firestore();
        let userEmail;
        var provider = new firebase.auth.GoogleAuthProvider();

        document.querySelector("#time").addEventListener("input", function(e) {
        const reTime = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;
        const time = this.value;
            if (reTime.exec(time)) {
                const minute = Number(time.substring(3,5));
                const hour = Number(time.substring(0,2)) % 12 + (minute / 60);
                this.style.backgroundImage = `url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><circle cx='20' cy='20' r='18.5' fill='none' stroke='%23222' stroke-width='3' /><path d='M20,4 20,8 M4,20 8,20 M36,20 32,20 M20,36 20,32' stroke='%23bbb' stroke-width='1' /><circle cx='20' cy='20' r='2' fill='%23222' stroke='%23222' stroke-width='2' /></svg>"), url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><path d='M18.5,24.5 19.5,4 20.5,4 21.5,24.5 Z' fill='%23222' style='transform:rotate(${360 * minute / 60}deg); transform-origin: 50% 50%;' /></svg>"), url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><path d='M18.5,24.5 19.5,8.5 20.5,8.5 21.5,24.5 Z' style='transform:rotate(${360 * hour / 12}deg); transform-origin: 50% 50%;' /></svg>")`;
            }
        });

        $(document).ready(function() {
            $("#signup-popup").hide();
            $("#irrigate-by-minutes").hide();
        });

        $("#signup").click(function(e) {
            e.preventDefault();
            $("#login-popup").hide();
            $("#signup-popup").show();
        })

        $("#back-to-login").click(function(e) {
            e.preventDefault();
            $("#login-popup").show();
            $("#signup-popup").hide();
        })

        $("#signup-popup").submit(function(e) {
            e.preventDefault();
            const email = $("#email-input-signup").val();
            const password = $("#password-input-signup").val();
            const dataplicityWormhole = $("#dataplicity-input-signup").val();
            $.ajax({
                url: `${dataplicityWormhole}/get_week`,
                type: "GET",
                success: function(response) {
                    auth.createUserWithEmailAndPassword(email, password).then(cred => {
                    db.collection("users").doc(email).set({
                        dataplicity: dataplicityWormhole
                    });
                    userEmail = email;
                    console.log(response);
                    drowData(response);
                    }, function(error) {
                        $("#signup-error-message").text(error.message);
                        $("#signup-error-message").show();
                    });

                },
                error: function(error) {
                    console.log(error);
                    $("#signup-error-message").text("Incorrect Dataplicity wormhole");
                }
            })
        });

        $("#login-popup").submit(function(e) {
            e.preventDefault();
            const email = $("#email-input-signin").val();
            const password = $("#password-input-signin").val();
            auth.signInWithEmailAndPassword(email, password).then(cred => {
                userEmail = email;
                login();
            }, function(err) {
                $("#signin-error-message").text(err.message);
                $("#signin-error-message").show();
            });
        });

        $("#logout-button").click(function(e) {
            e.preventDefault();
            auth.signOut().then(cred => {
                $("#login-popup").show();
                $("#login-popup").trigger('reset');
                $("#logup-popup").trigger('reset');
                $(".login-background").show();
                $(".login-background").trigger('reset');
                $(".main-container").trigger('reset');
                $("#signin-error-message").hide();
                $("#signup-error-message").hide();
                userEmail = "";
                window.scrollTo({top: 0, behavior: 'smooth'});
            }, function(error) {
                console.log(errror.message);
            });
        });

        $(".main-container").submit(function(e) {
            e.preventDefault();

            $(".time1Start").val() === "" ? cycle1StartTime = null : cycle1StartTime = `${$(".time1Start").val()}`;
            $(".time1End").val() === "" ? cycle1EndTime = null : cycle1EndTime = `${$(".time1End").val()}`;
            $(".time2Start").val() === "" ? cycle2StartTime = null : cycle2StartTime = `${$(".time2Start").val()}`;
            $(".time2End").val() === "" ? cycle2EndTime = null : cycle2EndTime = `${$(".time2End").val()}`;
            $(".time3Start").val() === "" ? cycle3StartTime = null : cycle3StartTime = `${$(".time3Start").val()}`;
            $(".time3End").val() === "" ? cycle3EndTime = null : cycle3EndTime = `${$(".time3End").val()}`;

            db.collection("users").doc(userEmail).get().then(function(user) {
                if (user.exists) {

                    $.ajax({
                        url: `${user.data()["dataplicity"]}/update_week`,
                        type: "POST",
                        data:                         
                            JSON.stringify({
                            "sunday":$("#1").is(':checked'),
                            "monday":$("#2").is(':checked'),
                            "tuesday":$("#3").is(':checked'),
                            "wednesday":$("#4").is(':checked'),
                            "thursday":$("#5").is(':checked'),
                            "friday":$("#6").is(':checked'),
                            "saturday":$("#7").is(':checked'),
                            "firstRoundStart":`${cycle1StartTime.split(":")[0]}:${cycle1StartTime.split(":")[1]}:00`,
                            "firstRoundEnd":`${cycle1EndTime.split(":")[0]}:${cycle1EndTime.split(":")[1]}:00`,
                            "secondRoundStart":`${cycle2StartTime.split(":")[0]}:${cycle2StartTime.split(":")[1]}:00`,
                            "secondRoundEnd":`${cycle2EndTime.split(":")[0]}:${cycle2EndTime.split(":")[1]}:00`,
                            "thirdRoundStart":`${cycle3StartTime.split(":")[0]}:${cycle3StartTime.split(":")[1]}:00`,
                            "thirdRoundEnd":`${cycle3EndTime.split(":")[0]}:${cycle3EndTime.split(":")[1]}:00`,
                            "isFirstRoundActive": $("#cycle1").is(':checked'),
                            "isSecondRoundActive": $("#cycle2").is(':checked'),
                            "isThirdRoundActive": $("#cycle3").is(':checked')
                        }),
                        headers: {
                            "Content-Type": "application/json"
                        },
                        success: function(response) {
                            console.log(response);
                            $("#submit-message").text("Saved!");
                            $("#submit-message").css('color', 'green');
                        },
                        error: function(error) {
                            console.log(error);
                            $("#submit-message").text("There was a problem");
                            $("#submit-message").css('color', 'red');
                        }
                    })

                } else {
                    console.log("No such document");
                }
            }).catch(function(error) {
                console.log("Error getting document:", error);
            });
        });

        function login() {
            db.collection("users").doc(userEmail).get().then(function(user) {
                if (user.exists) {
                    $.ajax({
                        url: `${user.data()["dataplicity"]}/get_week`,
                        type: "GET",
                        success: function(response) {
                            console.log(response);
                            drowData(response);
                                                },
                        error: function(error) {
                            console.log(error);
                        }
                    })
                } else {
                    console.log("No such document");
                }
            }).catch(function(error) {
                console.log("Error getting document:", error);
            });  
        };

        function drowData(response) {
            $("#signup-popup").hide();
            $("#login-popup").hide();
            $(".login-background").hide();

            // set dom objects:
            $("#cycle1").prop('checked', response["isFirstRoundActive"]);
            $("#cycle2").prop('checked', response["isSecondRoundActive"]);
            $("#cycle3").prop('checked', response["isThirdRoundActive"]);

            $(".time1Start").val(response["firstRoundStart"]);
            $(".time1End").val(response["firstRoundEnd"]);
            $(".time2Start").val(response["secondRoundStart"]);
            $(".time2End").val(response["secondRoundEnd"]);
            $(".time3Start").val(response["thirdRoundStart"]);
            $(".time3End").val(response["thirdRoundEnd"]);

            $("#1").prop('checked', response["sunday"]);
            $("#2").prop('checked', response["monday"]);
            $("#3").prop('checked', response["tuesday"]);
            $("#4").prop('checked', response["wednesday"]);
            $("#5").prop('checked', response["thursday"]);
            $("#6").prop('checked', response["friday"]);
            $("#7").prop('checked', response["saturday"]);

        }
        
        $(".irrigate-by-minutes-button").click(function(e) {
            e.preventDefault();
            $(".login-background").show();
            $("#irrigate-by-minutes").show();
        });

        $("#irrigate-by-minutes").submit(function(e) {
            e.preventDefault();

            db.collection("users").doc(userEmail).get().then(function(user) {
                if (user.exists) {

                    $.ajax({
                        url: `${user.data()["dataplicity"]}/irrigate_by_minutes/${$("#minutes-input").val()}`,
                        type: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        success: function(response) {
                            console.log(response);
                            $(".login-background").hide();
                            $("#irrigate-by-minutes").hide();
                        },
                        error: function(error) {
                            console.log(error);
                            $("#error-message-irrigate-by-minutes").text("There was a problem");
                            $("#error-message-irrigate-by-minutes").css('color', 'red');
                        }
                    })

                } else {
                    console.log("No such document");
                    $("#error-message-irrigate-by-minutes").text("There was a problem");
                    $("#error-message-irrigate-by-minutes").css('color', 'red');
                }
            }).catch(function(error) {
                console.log("Error getting document:", error);
                $("#error-message-irrigate-by-minutes").text("There was a problem");
                $("#error-message-irrigate-by-minutes").css('color', 'red');

            });

        });

        $("#close-button").click(function(e) {
            e.preventDefault();
            $(".login-background").hide();
            $("#irrigate-by-minutes").hide();
        });

        
    </script>
</body>
</html>
